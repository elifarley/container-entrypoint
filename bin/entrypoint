#!/bin/sh
CMD_BASE="$(readlink -f $0)" || CMD_BASE="$0"; CMD_BASE="$(dirname $CMD_BASE)"
set -e

test "$DEBUG" && set -x

_home="$(eval echo ~"$_USER")"; test -e "$_home" || _home="$HOME"

_INCLUDES='env-vars main'
for item in $_INCLUDES; do . "$CMD_BASE/../lib/$item.sh"; done

test -f "$_home"/image-build.log && echo "$_home/image-build.log:" && cat "$_home"/image-build.log && echo

SSH_CONFIG_VOLUME="${SSH_CONFIG_VOLUME:-/mnt-ssh-config}"

# If UID of docker.sock is not the same...
test -S /var/run/docker.sock && test $(id -u "$_USER") != $(stat -c "%u" /var/run/docker.sock) && {
  docker_gid=$(stat -c "%g" /var/run/docker.sock)
  getent group "$docker_gid" || groupadd -g "$docker_gid" docker
  test $docker_gid -ne $(id -g "$_USER") && \
    echo "Changing GID of '$_USER' from '$(id -g "$_USER")' to '$docker_gid' so that it matches that of '/var/run/docker.sock'..." && \
    usermod -g "$docker_gid" $_USER
}

MNT_DIR="${MNT_DIR:-/data}"
if test -e "$MNT_DIR"; then
  mnt_dir_uid=$(stat -c "%u" "$MNT_DIR")
  test $mnt_dir_uid -ne $(id -u "$_USER") && {
    if getent >/dev/null passwd $mnt_dir_uid; then
      echo "$MNT_DIR:"; ls -lhFa "$MNT_DIR"
      echo "'$MNT_DIR' is owned by an existing user. Let's change its owner to '$_USER'..."
      chown "$_USER" "$MNT_DIR" || return
    else
      echo "Changing UID of '$_USER' from '$(id -u "$_USER")' to '$mnt_dir_uid' so that it matches that of '$MNT_DIR'..."
      usermod -u $mnt_dir_uid "$_USER" || return
    fi
  }
else
  echo "Creating '$MNT_DIR'..."
  mkdir "$MNT_DIR" && chown "$_USER:$_USER" "$MNT_DIR"
fi

test -d "$_home"/.ssh || mkdir "$_home"/.ssh
# Fix permissions, if writable
test ! -w "$_home"/.ssh && echo "WARNING: '$_home/.ssh' is not writeable" || {
  touch "$_home"/.ssh/environment || return
  dir_not_empty "$SSH_CONFIG_VOLUME" && cp -av "$SSH_CONFIG_VOLUME"/* "$_home"/.ssh
  chown -R $_USER:$_USER "$_home"/.ssh && chmod -R 600 "$_home"/.ssh && chmod 700 "$_home"/.ssh
}

test -f "$_home"/build-info.txt && echo "$_home/build-info.txt:" && cat "$_home"/build-info.txt && echo

setup_env_vars

test -r "$_home"/.ssh/docker-config.json && {
  mkdir -p "$_home"/.docker
  test -f "$_home"/.docker/config.json || \
    ln -sv ../.ssh/docker-config.json "$_home"/.docker/config.json
}

test "$BUILD_MONIKER" && {
  echo "Hostname: changing from '$(cat /etc/hostname)' to '$BUILD_MONIKER'..."
  hostname "$BUILD_MONIKER" && echo "$BUILD_MONIKER" > /etc/hostname || \
    echo "Unable to change hostname."
}

# Copy default config from cache
dir_not_empty /etc/ssh || {
  test -d /etc/ssh && \
  echo "/etc/ssh is empty." && \
  dir_not_empty /etc/ssh.cache && cp -av /etc/ssh.cache/* /etc/ssh/
}

# Generate Host keys, if required
dir_not_empty /etc/ssh/ssh_host_* || {
  which ssh-keygen >/dev/null 2>&1 && ssh-keygen -A
}

ak="$_home"/.ssh/authorized_keys
test ! -f "$ak" && echo "WARNING: No SSH authorized_keys found at '$ak'" || {
  printf "\n$ak:\n"; cat "$ak"; echo
}

# Allow running SSHD as non-root user
test root != "$_USER" && test -d /etc/ssh && \
  chown -R $_USER:$_USER /etc/ssh && \
  test ! -d /var/run/sshd && \
    mkdir -p /var/run/sshd && chmod 0755 /var/run/sshd

test "$CEP_LOG_FILES" && linklogfiles

test -x /usr/local/bin/keytool-import-certs && dir_not_empty "$SSH_CONFIG_VOLUME"/certs && \
  /usr/local/bin/keytool-import-certs --force

test -x "$_home"/app-before-start.sh && {
  echo "[$(id -un)] About to run: $_home/app-before-start.sh"
  "$_home"/app-before-start.sh || return
}

id $_USER
test $# -eq 0 && test -x "$_home"/app.sh && set -- "$_home"/app.sh
echo "[$_USER] About to run: $*"

test "$(id -un)" = "$_USER" && sudo='' || {
  sudo="$(psudo) $_USER" || return
}

printf "exec $sudo $*
---------------------------------\n
" && exec $sudo "$@"
